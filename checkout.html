<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注文確認 - Makase-supa</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <div id="header"></div>

    <!-- Main Content -->
    <main class="py-4">
        <div class="container">
            <!-- Page Header -->
            <div class="mb-4">
                <h1><i class="fas fa-credit-card"></i> 注文確認</h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/index.html">ホーム</a></li>
                        <li class="breadcrumb-item"><a href="/cart.html">カート</a></li>
                        <li class="breadcrumb-item active">注文確認</li>
                    </ol>
                </nav>
            </div>

            <!-- Checkout Steps -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-center flex-fill">
                            <div class="badge bg-success rounded-circle p-3 mb-2">
                                <i class="fas fa-shopping-cart fa-lg"></i>
                            </div>
                            <div class="small">カート</div>
                        </div>
                        <div class="border-top flex-fill"></div>
                        <div class="text-center flex-fill">
                            <div class="badge bg-primary rounded-circle p-3 mb-2">
                                <i class="fas fa-file-invoice fa-lg"></i>
                            </div>
                            <div class="small fw-bold">注文確認</div>
                        </div>
                        <div class="border-top flex-fill"></div>
                        <div class="text-center flex-fill">
                            <div class="badge bg-secondary rounded-circle p-3 mb-2">
                                <i class="fas fa-check fa-lg"></i>
                            </div>
                            <div class="small">完了</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Shipping Form -->
                <div class="col-lg-8 mb-4">
                    <div class="bg-white p-4 rounded shadow-sm">
                        <h4 class="mb-4"><i class="fas fa-shipping-fast"></i> 配送情報</h4>
                        
                        <form id="checkoutForm">
                            <!-- Name -->
                            <div class="mb-3">
                                <label for="shippingName" class="form-label">
                                    お名前 <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="shippingName" required>
                            </div>

                            <!-- Phone -->
                            <div class="mb-3">
                                <label for="shippingPhone" class="form-label">
                                    電話番号 <span class="text-danger">*</span>
                                </label>
                                <input type="tel" class="form-control" id="shippingPhone" 
                                       placeholder="090-1234-5678" required>
                            </div>

                            <!-- Address -->
                            <div class="mb-3">
                                <label for="shippingAddress" class="form-label">
                                    配送先住所 <span class="text-danger">*</span>
                                </label>
                                <textarea class="form-control" id="shippingAddress" rows="3" 
                                          placeholder="東京都渋谷区道玄坂1-2-3" required></textarea>
                            </div>

                            <!-- Payment Method -->
                            <div class="mb-3">
                                <label class="form-label">
                                    支払い方法 <span class="text-danger">*</span>
                                </label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="paymentMethod" 
                                           id="codPayment" value="COD" checked>
                                    <label class="form-check-label" for="codPayment">
                                        <i class="fas fa-money-bill-wave"></i> 代金引換
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="paymentMethod" 
                                           id="bankPayment" value="BANK_TRANSFER">
                                    <label class="form-check-label" for="bankPayment">
                                        <i class="fas fa-university"></i> 銀行振込
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="paymentMethod" 
                                           id="cardPayment" value="CREDIT_CARD">
                                    <label class="form-check-label" for="cardPayment">
                                        <i class="fas fa-credit-card"></i> クレジットカード
                                    </label>
                                </div>
                            </div>

                            <!-- Note -->
                            <div class="mb-3">
                                <label for="orderNote" class="form-label">
                                    備考（オプション）
                                </label>
                                <textarea class="form-control" id="orderNote" rows="2" 
                                          placeholder="配達時間の希望など"></textarea>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="col-lg-4">
                    <div class="bg-white p-4 rounded shadow-sm sticky-top" style="top: 80px;">
                        <h4 class="mb-3">注文内容</h4>
                        
                        <!-- Items -->
                        <div id="orderItems" class="mb-3">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                            </div>
                        </div>

                        <!-- Summary -->
                        <hr>
                        <div class="mb-2 d-flex justify-content-between">
                            <span>小計:</span>
                            <strong id="summarySubtotal">¥0</strong>
                        </div>
                        <div class="mb-2 d-flex justify-content-between">
                            <span>配送料:</span>
                            <strong id="summaryShipping">¥0</strong>
                        </div>
                        <div class="mb-3 pb-3 border-bottom d-flex justify-content-between text-muted small">
                            <span>5,000円以上で送料無料</span>
                        </div>
                        <div class="mb-3 d-flex justify-content-between">
                            <h5>合計:</h5>
                            <h5 class="text-primary" id="summaryTotal">¥0</h5>
                        </div>

                        <!-- Place Order Button -->
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-lg" id="placeOrderBtn" onclick="placeOrder()">
                                <i class="fas fa-check-circle"></i> 注文を確定する
                            </button>
                            <a href="/cart.html" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left"></i> カートに戻る
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <div id="footer"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <!-- Core Scripts -->
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/utils.js"></script>
    
    <!-- Components -->
    <script src="js/components/header.js"></script>
    <script src="js/components/footer.js"></script>
    
    <!-- Page Script -->
    <script>
        let cartData = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check authentication
            if (!Auth.requireAuth()) {
                return;
            }

            loadCart();
            loadUserInfo();
        });

        // Load cart
        async function loadCart() {
            try {
                const userId = Auth.getUserId();
                const response = await API.getCart(userId);

                if (response.success && response.data) {
                    cartData = response.data;
                    
                    if (!cartData.items || cartData.items.length === 0) {
                        Utils.showAlert('カートが空です', 'warning');
                        setTimeout(() => {
                            window.location.href = '/cart.html';
                        }, 1500);
                        return;
                    }

                    displayOrderSummary(cartData);
                } else {
                    Utils.showAlert('カート情報の取得に失敗しました', 'danger');
                    setTimeout(() => {
                        window.location.href = '/cart.html';
                    }, 1500);
                }
            } catch (error) {
                console.error('Error loading cart:', error);
                Utils.handleApiError(error);
            }
        }

        // Load user info
        function loadUserInfo() {
            const fullName = Auth.getFullName();
            if (fullName) {
                document.getElementById('shippingName').value = fullName;
            }
        }

        // Display order summary
        function displayOrderSummary(cart) {
            const itemsContainer = document.getElementById('orderItems');
            
            itemsContainer.innerHTML = cart.items.map(item => `
                <div class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
                    <div class="flex-grow-1">
                        <div class="small fw-bold">${item.productName}</div>
                        <div class="small text-muted">${Utils.formatPrice(item.price)} × ${item.quantity}</div>
                    </div>
                    <div class="text-end">
                        <strong>${Utils.formatPrice(item.subtotal)}</strong>
                    </div>
                </div>
            `).join('');

            // Update summary
            const subtotal = cart.totalAmount || 0;
            const shippingFee = subtotal >= 5000 ? 0 : 500;
            const total = subtotal + shippingFee;

            document.getElementById('summarySubtotal').textContent = Utils.formatPrice(subtotal);
            document.getElementById('summaryShipping').textContent = Utils.formatPrice(shippingFee);
            document.getElementById('summaryTotal').textContent = Utils.formatPrice(total);
        }

        // Place order
        async function placeOrder() {
            const form = document.getElementById('checkoutForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const shippingName = document.getElementById('shippingName').value.trim();
            const shippingPhone = document.getElementById('shippingPhone').value.trim();
            const shippingAddress = document.getElementById('shippingAddress').value.trim();
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            const note = document.getElementById('orderNote').value.trim();

            // Validation
            if (!shippingName || !shippingPhone || !shippingAddress) {
                Utils.showAlert('必須項目を入力してください', 'warning');
                return;
            }

            // Confirm
            if (!confirm('注文を確定しますか？')) {
                return;
            }

            // Disable button
            const btn = document.getElementById('placeOrderBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 処理中...';

            try {
                const userId = Auth.getUserId();
                const response = await API.createOrder(userId, {
                    shippingName: shippingName,
                    shippingPhone: shippingPhone,
                    shippingAddress: shippingAddress,
                    paymentMethod: paymentMethod,
                    note: note || ''
                });

                if (response.success && response.data) {
                    Utils.showAlert('注文が完了しました！', 'success');
                    
                    // Clear cart count
                    Utils.updateCartCount(0);
                    
                    // Redirect to order detail
                    setTimeout(() => {
                        window.location.href = `/order-detail.html?id=${response.data.id}`;
                    }, 1500);
                } else {
                    Utils.showAlert(response.message || '注文に失敗しました', 'danger');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-check-circle"></i> 注文を確定する';
                }
            } catch (error) {
                console.error('Error placing order:', error);
                Utils.handleApiError(error);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check-circle"></i> 注文を確定する';
            }
        }
    </script>
</body>
</html>